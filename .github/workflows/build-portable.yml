name: Build Portable Node12 (32-bit) for Impressora_GP_iFood

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download Node.js 12 (32-bit)
        run: |
          mkdir nodejs
          curl -L https://nodejs.org/dist/v12.22.12/node-v12.22.12-win-x86.zip -o node12.zip
          tar -xf node12.zip -C nodejs --strip-components=1
          del node12.zip

      - name: Setup PATH
        run: echo "PATH=$env:CD\nodejs;$env:PATH" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      - name: Node version check
        run: |
          node -v
          npm -v

      - name: Install dependencies (rebuild native modules)
        run: |
          npm install --only=prod --build-from-source

      - name: Prepare portable package
        run: |
          mkdir dist
          xcopy nodejs dist\nodejs /E /I /Y
          xcopy server.js dist\ /Y
          if exist public xcopy public dist\public /E /I /Y
          if exist views xcopy views dist\views /E /I /Y
          if exist utils xcopy utils dist\utils /E /I /Y
          if exist routes xcopy routes dist\routes /E /I /Y
          if exist controllers xcopy controllers dist\controllers /E /I /Y
          xcopy package.json dist\ /Y
          xcopy node_modules dist\node_modules /E /I /Y
          copy run.bat dist\

      - name: Create portable ZIP
        run: powershell Compress-Archive -Path dist\* -DestinationPath impressora_portable.zip

      - name: Upload portable artifact
        uses: actions/upload-artifact@v4
        with:
          name: impressora_gp_portable
          path: impressora_portable.zip


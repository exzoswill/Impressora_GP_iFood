name: Build and Release macOS DMG

on:
  push:
    branches: [ macos-bundle ]
  workflow_dispatch:

jobs:
  build-release:
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare scripts
        run: |
          chmod +x utils/macos/create_app.sh utils/macos/embed_node.sh utils/macos/create_dmg.sh

      - name: Create .app bundle
        run: |
          ./utils/macos/create_app.sh "$(pwd)" "$RUNNER_TEMP/ImpressoraGPiFood.app"

      - name: Embed Node (from secret)
        env:
          NODE_VERSION: ${{ secrets.NODE_VERSION || '12.22.12' }}
        run: |
          ./utils/macos/embed_node.sh "$RUNNER_TEMP/ImpressoraGPiFood.app" "${NODE_VERSION}"

      - name: Import signing certificate
        if: ${{ secrets.P12_BASE64 && secrets.P12_PASSWORD }}
        env:
          P12_BASE64: ${{ secrets.P12_BASE64 }}
          P12_PASSWORD: ${{ secrets.P12_PASSWORD }}
        run: |
          set -e
          echo "$P12_BASE64" | base64 --decode > cert.p12
          security create-keychain -p ci_temp_keychain_pw ci-build.keychain || true
          security import cert.p12 -k ci-build.keychain -P "$P12_PASSWORD" -T /usr/bin/codesign
          security list-keychains -s ci-build.keychain
          security default-keychain -s ci-build.keychain
          security unlock-keychain -p ci_temp_keychain_pw ci-build.keychain

      - name: Find signing identity
        id: find_identity
        run: |
          set -e
          security find-identity -v -p codesigning | head -n 1

      - name: Codesign app
        if: ${{ secrets.P12_BASE64 && secrets.P12_PASSWORD }}
        env:
          IDENTITY: ${{ steps.find_identity.outputs.stdout }}
        run: |
          set -e
          ID=$(security find-identity -v -p codesigning | awk '/"/ {print $2; exit}' | tr -d '"')
          codesign --deep --force --verbose --sign "$ID" "$RUNNER_TEMP/ImpressoraGPiFood.app"

      - name: Create DMG
        run: |
          ./utils/macos/create_dmg.sh "$RUNNER_TEMP/ImpressoraGPiFood.app" "$RUNNER_TEMP/ImpressoraGPiFood.dmg"

      - name: Notarize (altool)
        if: ${{ secrets.APPLE_ID && secrets.APP_SPECIFIC_PASSWORD }}
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APP_SPECIFIC_PASSWORD: ${{ secrets.APP_SPECIFIC_PASSWORD }}
        run: |
          set -e
          xcrun altool --notarize-app -u "$APPLE_ID" -p "$APP_SPECIFIC_PASSWORD" --primary-bundle-id "br.ifood.ImpressoraGPiFood" -f "$RUNNER_TEMP/ImpressoraGPiFood.dmg"
          echo "Notarization submitted. Check Apple Notary logs in Actions output or manually."

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ github.run_number }}-macos
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload DMG to Release
        uses: softprops/action-upload-release-asset@v1
        with:
          tag: v${{ github.run_number }}-macos
          file: ${{ runner.temp }}/ImpressoraGPiFood.dmg
          name: ImpressoraGPiFood.dmg
